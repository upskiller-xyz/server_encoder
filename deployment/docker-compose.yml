version: '3.8'

services:
  encoder-server:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: encoder-server
    restart: unless-stopped
    ports:
      - "8082:8082"  # Map host port 8082 to container port 8082
    environment:
      - PORT=8082
      - WORKERS=${WORKERS:-1}
      - THREADS=${THREADS:-8}
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      - CUDA_VISIBLE_DEVICES=-1
      - TF_CPP_MIN_LOG_LEVEL=3
      - OPENCV_IO_ENABLE_OPENEXR=0
      - OMP_NUM_THREADS=1
    env_file:
      - .env.docker
    volumes:
      # Optional: Mount logs directory for persistence
      - ./logs:/var/log/encoder-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - encoder-network

  # Optional: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: encoder-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-docker.conf:/etc/nginx/conf.d/default.conf:ro
      # Optional: SSL certificates
      # - ./ssl/cert.pem:/etc/nginx/ssl/cert.pem:ro
      # - ./ssl/key.pem:/etc/nginx/ssl/key.pem:ro
    depends_on:
      - encoder-server
    networks:
      - encoder-network
    profiles:
      - with-nginx

networks:
  encoder-network:
    driver: bridge
